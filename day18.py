from anytree import Node, RenderTree, findall, walker
import numpy as np
import copy


inp = """#################################################################################
#.#.......#...........#...#............p#.....#.#...#...........#..w............#
#.#.#.###.#.#.#####.###.#.#########.###.#.###.#.#.#.#.#######.#.#######.#######.#
#...#.#...#.#.#...#.#...#.........#...#.#.#.#.#...#...#.....#.#.....#...#.......#
#.###.#.#####.#.#.###.###########.###U#.#.#.#.#.#######.###.#.#####.#.###.#######
#.#.#.#.......#.#...#...#.......#.#...#.#.#.#.#...#.......#.#...#.#.#...#.#.....#
#J#.#.#########.###.#.#.#.#######.#.###.#.#.#.#####.#######.#.#.#.#.#.#.###.###.#
#...#.........#...#.#.#.#.#.....#.#.#...#.#.#.......#.#.....#.#.#.#.#.#...#.#.#.#
###.#########.###.#.###.#.#.###.#.#.#.###.#.#########.#.#######.#.#.#####.#.#.#.#
#...#...#...#.#...#.#...#...#...#.#.#...#.....#.....#.#...#...#.#...#.L.#.#.#.#o#
#.###.###.#.#.#.###.#.#######.#.#.#.#########.#.###.#.###.#.#.#.###.#.#.#.#.#.#.#
#...#...#.#...#.#.....#...#...#.#.#.E...#...#...#.#.#...#...#.#...#...#.#...#.#.#
###.###.#.#####.#######.#.#.###.#.#.###.###.#####.#.###.#####.#.#.#####.#.###.#.#
#.....#.#...#...#...#...#...#...#.#.#...#...#.....#.#...#...#.#.#.#.....#.T..d#.#
#####.#.###.#.###.#.###.#####.###.###.#.#.#.#.###.#.#.#.###.#.#.#.###.#########.#
#...#...#...#.....#...#.....#z..#.....#.#.#...#...#.#.#.#...#.#.#...#...........#
#.#.#####.#.#########.#.###.###########.#.#######.#.#.#.#.#.#.#.###.###########.#
#.#...#...#...#.#.....#.#...#.........#.#.#.....#.#.#.#...#.#.#.#...#...#...#...#
#.###.#.#####.#.#.#####.#.###.#.#######.#.#.###.###.#.#####.#.###.###.#.#.#.#.###
#.#...#.#...#.#.#.#.....#.....#...#.....#.#...#.....#.....#.#...#.#...#...#...#.#
#.###.#.#.###.#.#.#####X#########.#.#####.###.#######.###.#.###V#.#.#########.#.#
#.S.#...#...#...#...#.#.#...#...#.#.....#..b#.....#.#...#.#.#...#.#.....#...#...#
#.#.#####.#.###.###.#.#.#.###.#.#.#####.#.#.#####.#.#.###.#.#####.#######.#.#####
#.#.#.....#...#...#...#.#.....#.#.....#.#.#.....#.#.#.#...#.....#.........#s....#
#.#.#.#######I###.#####.#######.#####.#.#.#######.#.#.#.#########.#############.#
#.#.#.#...#.....#.....#.#...#.......#.#.#.#.....#.#...#.#.......#.#...#.......#.#
###.#.###.#.#########.#.#.#.#.#####.#.#.#.#.###.#.#####.#.#####.#.#.#.###.###.#.#
#...#.#...#...#...#...#...#...#...#.#...#.#...#.#.#...#.#...#...#...#.....#m#.#.#
#.###.#.#####.#.#.#.###########.#.#.#####.###.#.#.#.#.#.###.#.#############.#.#.#
#...#.#.....#...#.#.#.#.........#.#.#...#...#.#.#...#.#.....#.................#.#
###.#.###.#.#####.#.#.#.#########.#.#.#.#.#.#.#.#####.#########################.#
#...#.....#...#.#...#.#.#.#.......#.#.#.#.#...#.....#.....#...................#.#
#.###########.#.#####.#G#.#.#####.#.#.#.#.#########.#####.#.#################.#.#
#.........#...#.......#...#.#.....#...#.#.........#.....#.#.#...............#...#
#.#######.#.###.#########.#.#.#########.#########.#.#####.#.#.###########.#.###.#
#q#.#.....#.....#.....#..k#r#.#.........#.#.......#.....#...#...#.......#.#...#.#
#.#.#.###########.###.#.###.###.#########.#.###########.#######.#.#.###.#.#####.#
#...#.#...#.......#.#.#.#.#...#.#.....#.#.#.#.....#...#.........#.#.#..g#.C.#...#
###.#.#.#.#.#######.#.#.#.###.#.#.###.#.#.#.#.###.#.#.#############.#.#####.#.###
#...#...#.......A..c#.......#.....#...........#.....#.......R.......#.....#.....#
#######################################.@.#######################################
#.....#.....#...#................f....#.................F...#.........#.........#
#.###.###.###.#.#.###.###############.#.#.#########.#.#####.#.###.###.#.#######.#
#.#.......#...#...#...#.....#.......#...#...#.....#.#.#.#...#...#...#.#.Q.#...#.#
#.#########.#######.###.###.#.#.#######.#####.###.###.#.#.#####.###.#####.#.###.#
#.........#...#.......#.#.#.#.#.....#...#.....#.......#.#.....#.#...#.......#...#
#.#######.###.#.#######.#.#.#######.#.###.#############.#####.#.#.###.#######.#.#
#.Ot#.#.....#.#...#...#.#.#...#.....#...#...#...#.......#.....#.#.......#.#...#.#
###.#.#.#####.#####.#.#.#.###.#.###.###.#.#.#.#.#####.#.#.#############.#.#.###.#
#.#.#.#.....#.......#.....#...#.#.#.#...#.#...#.....#.#.#.#..a......#.....#.#...#
#.#.#.#####.###############.###.#.#.#.###.#########.#.#.#.#####.###.#######.#.###
#.#.#.....#...........#.....#...#.#.#.#.#.#.......#.#.#.#...#...#.......#...#...#
#.#.###.#####.#####.###.#####.###.#.#.#.###.#####.#.#.#.###.#.#########.#.#####.#
#.#.....#.....#.#...#...#.....#...#.#...#...#...#...#.#...#.#.....#.......#.....#
#.###.###.#####.#.###.###.#####.#.#.###.#.###.#.#####.#.###.#.###K###############
#.....#...#...#.....#.#.....#...#...#...#.....#.#.....#.#...#.#...#.....#.....N.#
#.#####.###.###.#####.#####.#.#######.###.#####.###.#####.###.#.#.#.###.#.#####.#
#.#.....#...#...#.....#.....#.....#.#.#.#.....#...#.....#...#.#.#.#...#...#...#.#
#.#.#####.#.#.###.#####.#########.#.#.#.#####.###.#.###.###.###.#.###.#####.###.#
#.#.....#.#...#.#.#.........#.....#.#.#.#...#.#.#.#...#.........#...#.#.....#...#
#.#####M#.#####.#.#####.###.#####.#.#.#.#.#.#.#.#.###################.#.#.###.###
#...#...#.#.....#.....#...#.....#.#.#.#.#.#.#.#.#.#.........#..y..H...#.#.....#.#
###.#.###.#.###.#########.#####.#.#.#.#.#.#.#.#.#.#.#######.###########.#######.#
#.#.#...#.#h#...#.......#.#.#..x#...#...#.#.#.#.#...#.......#.........#...#.....#
#.#.###.#.###.#.#.#####.#.#.#.#.#######.#.#.#.#.#####.#####.#.###.###.###.#.###.#
#...#...#.#...#.#.#...#.#...#.#.#...#.B.#.#.#...#...#.#...#.#...#...#...#...#.#.#
#.###.###.#.###.#.#.###.###.#.###.#.#.###.#.###.#.#.#.#.#.#.#######.###.#####.#.#
#.#...#.#.#...#...#.......#.#.....#.#...#.#...#.#.#.#.#.#.#...#.....#...#.....#.#
###.###.#.#.#.#####.#######.#######.###.#.#####.#.#.#.###.###.#.#######.#.###.#.#
#...#.#...#.#.#...#.Y...#...#.....#.....#.......#.#.#...#.....#.#.....#.#...#...#
#.###.#.###.#.#.#.#######.###.###.#######.#########.###.#####.#.#.###.#####.#####
#.#...D.#v..#.#.#.#.......#...#...#...#.#...#...#.....#.....#.#.#.#.#.....#...#.#
#.###.###.###.#.#.#.#######.###.#.#.#.#.###.#.#Z#.#########.#.#.#.#.#####.###.#.#
#...#...#.#...#.#...#...#.....#.#.#.#...#.#...#.#...#.......#...#.#...#.....#...#
#.#.###.###W#.#.#####.###.#####.#.#.#####.#####.#.#.#.#####.#####.#.#P#.#.#####.#
#.#...#.....#.#.....#.......#...#.#..l..#.....#.#.#.#.#.....#.....#.#.#.#.#...#i#
#.###.#######.#####.#.#######.###.#####.#.###.#.#.#.#.#######.#####.###.###.#.#.#
#...#...#....n#.....#...#..u..#...#.....#...#.#.#.#.#.....#...#.....#...#...#...#
###.###.#######.#########.#####.###.###.#.#.###.###.#####.#.###.###.#.###.#######
#.....#..e................#.........#...#.#.............#.......#...#........j..#
#################################################################################"""

inp = inp.split('\n')
for i, line in enumerate(inp):
    inp[i] = list(line)

print(inp)

def fin(crd, grid, node, banned):
    try:
        if node.parent is None:
            if grid[crd[0]][crd[1]] not in banned:
                create(Node(crd, parent=node, tile=grid[crd[0]][crd[1]]), grid, banned)
                return True
        else:
            if grid[crd[0]][crd[1]] not in banned and node.parent.name != crd:
                create(Node(crd, parent=node, tile=grid[crd[0]][crd[1]]), grid, banned)
                return True
    except Exception as e:
        print(e)
    return False

def create(node, grid, banned):
    flg = False
    crd = node.name


    a1 = fin([crd[0] - 1, crd[1]], grid, node, banned)
    a2 = fin([crd[0] + 1, crd[1]], grid, node, banned)
    a3 = fin([crd[0], crd[1] - 1], grid, node, banned)
    a4 = fin([crd[0], crd[1] + 1], grid, node, banned)

    if not (a1 or a2 or a3 or a4):
        return 0


for r, row in enumerate(inp):
    try:
        coords = [r, row.index('@')]
    except ValueError:
        pass

#daddy = Node(coords, tile='.')
#create(daddy, np.array(inp))
#print(RenderTree(node))
steplist = []
def generate(coords, grid, steps):
    banned = [chr(x) for x in range(ord('A'), ord('Z') + 1)] + ['#']
    keys = [chr(x) for x in range(ord('a'), ord('z') + 1)]
    daddy = Node(coords, tile='.')
    create(daddy, grid, banned)
    keylocs = findall(daddy, lambda n: n.tile in keys)
    if keylocs == ():
        steplist.append(steps)
    for knode in keylocs:
        nsteps = steps + knode.depth
        key = knode.tile
        ngrid = copy.deepcopy(grid)
        for i, row in enumerate(ngrid):
            for j, tile in enumerate(row):
                if tile == key or tile == key.capitalize():
                    ngrid[i][j] = '.'
        generate(knode.name, ngrid, nsteps)

print(coords)
generate(coords, inp, 0)
print(sorted(steplist))